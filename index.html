<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸŸï¸ ãƒã‚±ãƒƒãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼ Pro v2</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Special+Elite&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f172a;--panel:#1e293b;--panel2:#334155;
  --bdr:rgba(255,255,255,.1);--gold:#fbbf24;
  --txt:#f8fafc;--sub:#94a3b8;
  --blue:#3b82f6;--red:#ef4444;
  --hdr:50px;--tab-h:50px;--pnl-h:160px;--ctrl-h:44px;
  --side-w:260px;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Noto Sans JP',sans-serif;color:var(--txt);-webkit-tap-highlight-color:transparent}

/* â”€â”€ Header â”€â”€ */
#hdr{
  position:fixed;top:0;left:0;right:0;height:var(--hdr);z-index:200;
  background:var(--panel);border-bottom:1px solid var(--bdr);
  display:flex;align-items:center;padding:0 12px;gap:8px;
}
.logo{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--gold);flex:1}
.hbtn{background:var(--panel2);border:1px solid var(--bdr);color:var(--txt);font-size:.7rem;font-weight:700;padding:6px 10px;border-radius:6px;cursor:pointer}

/* â”€â”€ Sidebar (ãƒ¬ã‚¤ãƒ¤ãƒ¼ & ã‚°ãƒ«ãƒ¼ãƒ—) â”€â”€ */
#side{
  position:fixed;left:0;top:var(--hdr);bottom:0;width:var(--side-w);
  background:var(--panel);border-right:1px solid var(--bdr);
  z-index:195;display:flex;flex-direction:column;
  transform:translateX(-100%);transition:transform 0.3s;
}
#side.open{transform:translateX(0)}
.side-hdr{padding:14px;font-size:0.85rem;font-weight:900;border-bottom:1px solid var(--bdr);display:flex;justify-content:space-between}
#lyrs{flex:1;overflow-y:auto;padding:8px}
.lyr-item{
  display:flex;align-items:center;padding:8px;gap:6px;background:var(--panel2);
  border-radius:8px;margin-bottom:4px;border:2px solid transparent;cursor:pointer;
}
.lyr-item.sel{border-color:var(--blue)}
.lyr-check{width:18px;height:18px;cursor:pointer}
.lyr-info{flex:1;font-size:0.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.side-ftr{padding:10px;border-top:1px solid var(--bdr);display:flex;gap:5px}
.sbtn{flex:1;padding:8px;font-size:0.7rem;border-radius:6px;border:none;background:var(--blue);color:white;font-weight:700;cursor:pointer}
.sbtn.sec{background:var(--panel2)}

#side-toggle{
  position:fixed;left:12px;top:calc(var(--hdr) + 12px);z-index:196;
  width:40px;height:40px;border-radius:10px;background:var(--panel);border:1px solid var(--bdr);
  color:var(--gold);font-size:1.2rem;cursor:pointer;
}

/* â”€â”€ Canvas â”€â”€ */
#cv{position:fixed;left:0;right:0;top:var(--hdr);touch-action:none}

/* â”€â”€ Control Zone (æ“ä½œãƒ‘ãƒãƒ«ã®æ•´ç†) â”€â”€ */
#ctrl-zone{
  position:fixed;bottom:0;left:0;right:0;z-index:190;
  background:var(--panel);border-top:1px solid var(--bdr);
}

/* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‹ã‚‰ã€Œå›ºå®šãƒãƒ¼ã€ã¸å¤‰æ›´ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’é‚ªé­”ã—ãªã„ï¼‰ */
#ftb{
  display:none;background:rgba(15,23,42,0.9);height:var(--ctrl-h);
  border-bottom:1px solid var(--bdr);align-items:center;padding:0 8px;gap:8px;overflow-x:auto;
}
#ftb.show{display:flex}
.fb{background:var(--panel2);color:white;border:none;padding:5px 10px;border-radius:4px;font-size:0.65rem;white-space:nowrap;cursor:pointer}
.fb.del{background:var(--red)}

/* Tabs & Panels */
#tabs{display:flex;height:var(--tab-h);border-top:1px solid var(--bdr)}
.tab{flex:1;background:none;border:none;color:var(--sub);font-size:0.7rem;font-weight:700;cursor:pointer}
.tab.on{color:var(--gold);background:rgba(251,191,36,0.1)}
#pnls{height:var(--pnl-h);overflow-x:auto;display:none;padding:12px}
#pnls.show{display:block}
.pnl{display:none;gap:8px}
.pnl.on{display:flex}

/* å›³å½¢ãƒ»ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚¢ã‚¤ãƒ†ãƒ  */
.gi{flex-shrink:0;width:64px;height:80px;background:var(--panel2);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:0.6rem}

/* Modals & Toast */
#clrM, #txM{position:fixed;inset:0;z-index:500;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7)}
.modal-content{background:var(--panel);padding:20px;border-radius:16px;width:90%;max-width:400px}
#toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);background:var(--gold);color:#000;padding:8px 16px;border-radius:20px;font-weight:900;opacity:0;transition:0.3s;z-index:1000}
#zbdg{position:fixed;right:12px;top:62px;background:rgba(0,0,0,0.5);padding:4px 8px;border-radius:10px;font-size:0.6rem;pointer-events:none}
</style>
</head>
<body>

<header id="hdr">
  <div class="logo">ğŸŸï¸ TICKET PRO</div>
  <button class="hbtn" onclick="fitView()">âŠ¡ ãƒ•ã‚£ãƒƒãƒˆ</button>
  <button class="hbtn" onclick="doSave()">ğŸ’¾ ä¿å­˜</button>
</header>

<button id="side-toggle" onclick="toggleSidebar()">â‰¡</button>

<aside id="side">
  <div class="side-hdr">
    <span>ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</span>
    <button onclick="toggleSidebar()" style="background:none;border:none;color:var(--sub)">âœ•</button>
  </div>
  <div id="lyrs"></div>
  <div class="side-ftr">
    <button class="sbtn" onclick="groupSelected()">é¸æŠã—ãŸé …ç›®ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</button>
    <button class="sbtn sec" onclick="ungroupSelected()">è§£é™¤</button>
  </div>
</aside>

<canvas id="cv"></canvas>

<div id="ctrl-zone">
  <div id="ftb">
    <button class="fb" onclick="openClr('fill')">ğŸ¨ è‰²</button>
    <button class="fb" onclick="mvZ(1)">â†‘ å‰é¢</button>
    <button class="fb" onclick="mvZ(-1)">â†“ èƒŒé¢</button>
    <button class="fb" onclick="dupEl()">ï¼‹ è¤‡è£½</button>
    <button class="fb del" onclick="delEl()">å‰Šé™¤</button>
    <div style="flex:1"></div>
    <button class="fb" onclick="selId=null;updateUI()">âœ• é–‰ã˜ã‚‹</button>
  </div>

  <div id="pnls" class="show">
    <div id="pShapes" class="pnl on"></div>
    <div id="pStickers" class="pnl"></div>
    <div id="pText" class="pnl">
       <input id="txin" type="text" placeholder="æ–‡å­—..." style="padding:8px;border-radius:6px;border:none;width:100px">
       <button class="fb" onclick="addTx()" style="height:36px">è¿½åŠ </button>
    </div>
  </div>

  <div id="tabs">
    <button class="tab on" onclick="swTab('shapes')">å›³å½¢</button>
    <button class="tab" onclick="swTab('stickers')">ã‚¹ã‚¿ãƒ³ãƒ—</button>
    <button class="tab" onclick="swTab('text')">ãƒ†ã‚­ã‚¹ãƒˆ</button>
    <button class="tab" onclick="togglePnls()">â–¼</button>
  </div>
</div>

<div id="clrM" onclick="closeClr()"><div class="modal-content" onclick="event.stopPropagation()"><h3>è‰²ã‚’é¸æŠ</h3><div id="swGrid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px"></div></div></div>
<div id="toast">Saved!</div>
<div id="zbdg">100%</div>

<script>
'use strict';
// åŸºæœ¬å®šæ•°
const TW=600, TH=280, DPR=window.devicePixelRatio||1, HANDLE_HIT=26; // å½“ãŸã‚Šåˆ¤å®šã‚’å¤§ãã
let els=[], nid=1, selId=null, bgCol='#1e293b', vx=0, vy=0, vz=1, multiSelects=new Set();
const cv=document.getElementById('cv'), ctx=cv.getContext('2d'), activePtrs={};
let gesture=null;

// æ•°å­¦ãƒ»åº§æ¨™å¤‰æ›
const s2t = (sx, sy) => [(sx - vx) / vz, (sy - vy) / vz];
const t2s = (tx, ty) => [tx * vz + vx, ty * vz + vy];
const d2 = (ax, ay, bx, by) => Math.sqrt((bx - ax) ** 2 + (by - ay) ** 2);

function resize() {
  const h=window.innerHeight, w=window.innerWidth, hh=50;
  cv.width=w*DPR; cv.height=(h-hh)*DPR; cv.style.width=w+'px'; cv.style.height=(h-hh)+'px';
}

function fitView() {
  const avW=window.innerWidth*0.9, avH=(window.innerHeight-260)*0.8;
  vz=Math.min(avW/TW, avH/TH); vx=(window.innerWidth-TW*vz)/2; vy=60;
  document.getElementById('zbdg').textContent=Math.round(vz*100)+'%';
}

// â”€â”€ ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãƒ­ã‚¸ãƒƒã‚¯ â”€â”€
function groupSelected() {
  if (multiSelects.size < 2) return;
  const gid = 'g' + (nid++);
  els.forEach(el => { if (multiSelects.has(el.id)) el.groupId = gid; });
  multiSelects.clear();
  refreshSidebar();
}
function ungroupSelected() {
  els.forEach(el => { if (multiSelects.has(el.id)) delete el.groupId; });
  multiSelects.clear();
  refreshSidebar();
}

// â”€â”€ ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–° â”€â”€
function toggleSidebar(){ document.getElementById('side').classList.toggle('open'); }
function refreshSidebar() {
  const container = document.getElementById('lyrs'); container.innerHTML = '';
  [...els].reverse().forEach(el => {
    const item = document.createElement('div');
    item.className = `lyr-item ${el.id === selId ? 'sel' : ''}`;
    item.onclick = () => { selId = el.id; updateUI(); };
    
    const chk = document.createElement('input');
    chk.type = 'checkbox'; chk.className = 'lyr-check';
    chk.checked = multiSelects.has(el.id);
    chk.onclick = (e) => { e.stopPropagation(); if(chk.checked) multiSelects.add(el.id); else multiSelects.delete(el.id); };

    const info = document.createElement('div');
    info.className = 'lyr-info';
    info.textContent = (el.groupId ? `[${el.groupId}] ` : '') + (el.text || el.sub || el.type);

    const lockBtn = document.createElement('button');
    lockBtn.innerHTML = el.locked ? 'ğŸ”’' : 'ğŸ”“';
    lockBtn.style = "background:none;border:none;cursor:pointer";
    lockBtn.onclick = (e) => { e.stopPropagation(); el.locked = !el.locked; refreshSidebar(); };

    item.append(chk, info, lockBtn);
    container.appendChild(item);
  });
}

// â”€â”€ æç”» â”€â”€
function drawEl(c, el) {
  if (el.hidden) return;
  const cx = el.x + el.w/2, cy = el.y + el.h/2;
  const [sx, sy] = t2s(cx, cy);
  c.save(); c.translate(sx, sy); c.rotate(el.r || 0); c.scale(vz, vz);
  
  c.globalAlpha = el.op || 1;
  if (el.type === 'text') {
    c.fillStyle = el.fill; c.font = `bold ${el.fs}px sans-serif`;
    c.textAlign = 'center'; c.textBaseline = 'middle'; c.fillText(el.text, 0, 0);
  } else {
    c.fillStyle = el.fill || varGold;
    if(el.sub==='rect') c.fillRect(-el.w/2, -el.h/2, el.w, el.h);
    else if(el.sub==='circle') { c.beginPath(); c.arc(0,0,el.w/2,0,Math.PI*2); c.fill(); }
    else { // ç°¡æ˜“è¡¨ç¤º
       c.fillRect(-el.w/2, -el.h/2, el.w, el.h);
       c.fillStyle="#000"; c.fillText(el.sub, 0, 0);
    }
  }
  c.restore();
}

function render() {
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.save(); ctx.scale(DPR, DPR);
  // ãƒã‚±ãƒƒãƒˆå°ç´™
  ctx.fillStyle = bgCol;
  ctx.shadowBlur = 20; ctx.shadowColor = 'rgba(0,0,0,0.5)';
  ctx.fillRect(vx, vy, TW*vz, TH*vz);
  ctx.shadowBlur = 0;

  els.forEach(el => drawEl(ctx, el));

  // é¸æŠæ ã¨ãƒãƒ³ãƒ‰ãƒ«
  if(selId) {
    const el = els.find(e => e.id === selId);
    if(el && !el.locked) {
      const [sx, sy] = t2s(el.x+el.w/2, el.y+el.h/2), hw=el.w/2*vz, hh=el.h/2*vz;
      ctx.save(); ctx.translate(sx, sy); ctx.rotate(el.r||0);
      ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2; ctx.strokeRect(-hw, -hh, hw*2, hh*2);
      // ãƒãƒ³ãƒ‰ãƒ«ï¼ˆæ‹¡å¤§ç”¨ï¼šå³ä¸‹ã€å›è»¢ç”¨ï¼šä¸Šï¼‰
      ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(hw, hh, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(0, -hh-30, 10, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }
  }
  ctx.restore();
  requestAnimationFrame(render);
}

// â”€â”€ å½“ãŸã‚Šåˆ¤å®šï¼ˆå¼·åŒ–ç‰ˆï¼‰ â”€â”€
function getHit(sx, sy) {
  if(!selId) return null;
  const el = els.find(e => e.id === selId);
  const [cx, cy] = t2s(el.x + el.w/2, el.y + el.h/2), a = el.r || 0;
  // å›è»¢ãƒãƒ³ãƒ‰ãƒ«
  const [rx, ry] = [cx + Math.sin(a)*0 - Math.cos(a)*0, cy + Math.sin(a)*0 + Math.cos(a)*(-el.h/2*vz-30)];
  if (d2(sx, sy, rx, ry) < HANDLE_HIT) return 'rot';
  // æ‹¡å¤§ãƒãƒ³ãƒ‰ãƒ« (å³ä¸‹)
  const [ex, ey] = [cx + Math.cos(a)*(el.w/2*vz) - Math.sin(a)*(el.h/2*vz), cy + Math.sin(a)*(el.w/2*vz) + Math.cos(a)*(el.h/2*vz)];
  if (d2(sx, sy, ex, ey) < HANDLE_HIT) return 'resize';
  return null;
}

function findElAt(sx, sy) {
  const [tx, ty] = s2t(sx, sy);
  for(let i=els.length-1; i>=0; i--) {
    const el = els[i]; if(el.locked) continue;
    if(tx > el.x && tx < el.x+el.w && ty > el.y && ty < el.y+el.h) return el;
  }
  return null;
}

// â”€â”€ ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ â”€â”€
cv.addEventListener('pointerdown', e => {
  const sx = e.clientX, sy = e.clientY - 50;
  const hit = getHit(sx, sy);
  if(hit) {
    gesture = { type: hit, el: els.find(e => e.id === selId), sx, sy, w0: els.find(e => e.id === selId).w, r0: els.find(e => e.id === selId).r };
    return;
  }
  const el = findElAt(sx, sy);
  if(el) {
    selId = el.id; updateUI();
    const group = el.groupId ? els.filter(e => e.groupId === el.groupId) : [el];
    gesture = { type: 'move', targets: group, sx, sy, startPos: group.map(g => ({x: g.x, y: g.y})) };
  } else {
    selId = null; updateUI();
  }
});

window.addEventListener('pointermove', e => {
  if(!gesture) return;
  const sx = e.clientX, sy = e.clientY - 50, dx = (sx - gesture.sx)/vz, dy = (sy - gesture.sy)/vz;
  if(gesture.type === 'move') {
    gesture.targets.forEach((t, i) => { t.x = gesture.startPos[i].x + dx; t.y = gesture.startPos[i].y + dy; });
  } else if(gesture.type === 'resize') {
    gesture.el.w = Math.max(20, gesture.w0 + dx);
    gesture.el.h = gesture.el.w * (gesture.w0 / gesture.w0); // ç¸¦æ¨ªæ¯”ç¶­æŒ
  } else if(gesture.type === 'rot') {
    gesture.el.r = gesture.r0 + (sx - gesture.sx) * 0.02;
  }
});
window.addEventListener('pointerup', () => gesture = null);

// â”€â”€ UIæ“ä½œ â”€â”€
function updateUI() {
  document.getElementById('ftb').classList.toggle('show', !!selId);
  refreshSidebar();
}
function swTab(t) {
  document.querySelectorAll('.tab').forEach(b => b.classList.toggle('on', b.innerText.includes(t)));
  document.querySelectorAll('.pnl').forEach(p => p.classList.toggle('on', p.id === 'p' + t.charAt(0).toUpperCase() + t.slice(1)));
  document.getElementById('pnls').classList.add('show');
}
function togglePnls() { document.getElementById('pnls').classList.toggle('show'); }

function mkEl(type, sub, extra) {
  const el = { id: 'e'+(nid++), type, sub, x: 100, y: 100, w: 80, h: 80, fill: '#fbbf24', op: 1, ...extra };
  els.push(el); selId = el.id; updateUI();
}
function addTx() { mkEl('text', 'text', { text: document.getElementById('txin').value, fs: 40 }); }
function delEl() { els = els.filter(e => e.id !== selId); selId = null; updateUI(); }
function dupEl() { 
  const src = els.find(e => e.id === selId);
  if(src) mkEl(src.type, src.sub, {...src, id: 'e'+(nid++), x: src.x+20, y: src.y+20});
}
function mvZ(d) {
  const idx = els.findIndex(e => e.id === selId);
  if (idx >= 0 && els[idx+d]) { [els[idx], els[idx+d]] = [els[idx+d], els[idx]]; updateUI(); }
}

const SWATCHES = ['#ffffff','#000000','#ef4444','#fbbf24','#22c55e','#3b82f6','#a855f7','#f472b6'];
function buildSwatches() {
  const g = document.getElementById('swGrid');
  SWATCHES.forEach(c => {
    const s = document.createElement('div');
    s.style = `background:${c};height:40px;border-radius:8px;cursor:pointer;border:1px solid var(--bdr)`;
    s.onclick = () => { const el = els.find(e => e.id === selId); if(el) el.fill = c; closeClr(); };
    g.appendChild(s);
  });
}
function openClr() { document.getElementById('clrM').style.display = 'flex'; }
function closeClr() { document.getElementById('clrM').style.display = 'none'; }

// åˆæœŸåŒ–
resize();
buildSwatches();
const shapes = [{s:'rect',n:'å››è§’'},{s:'circle',n:'å††'}];
shapes.forEach(sh => {
  const d = document.createElement('div'); d.className='gi'; d.innerHTML=`<span>${sh.n}</span>`;
  d.onclick = () => mkEl('shape', sh.s); document.getElementById('pShapes').appendChild(d);
});
fitView();
render();
window.addEventListener('resize', resize);
</script>
</body>
</html>
